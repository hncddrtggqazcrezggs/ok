local playersService = game:GetService("Players")
local workspaceService = game:GetService("Workspace")
local runService = game:GetService("RunService")
local userInputService = game:GetService("UserInputService")
local tweenService = game:GetService("TweenService")

local espModule = {}
espModule.__index = espModule

espModule.Config = {
    TeamCheck = true,
    ESPDistance = 1000,
    BoxColor = Color3.new(0.403922, 0.34902, 0.701961),
    BoxGradientEnabled = false,
    BoxGradientColor1 = Color3.new(0.403922, 0.34902, 0.701961),
    BoxGradientColor2 = Color3.new(0.8, 0.4, 1),
    BoxOutlineEnabled = true,
    BoxOutlineColor = Color3.new(0, 0, 0),
    SkeletonColor = Color3.new(0.403922, 0.34902, 0.701961),
    ChamsColor = Color3.new(0.403922, 0.34902, 0.701961),
    TracerOrigin = "Bottom Screen",
    TracerColor = Color3.new(0.403922, 0.34902, 0.701961),
    ChamsFillTransparency = 0.5,
    ChamsOutlineColor = Color3.new(1, 1, 1),
    HealthBarLerpSpeed = 0.2,
}

espModule.State = {
    BoxEnabled = false,
    NameEnabled = false,
    DistanceEnabled = false,
    SkeletonEnabled = false,
    HealthTextEnabled = false,
    HealthBarEnabled = false,
    TracerEnabled = false,
    ChamsEnabled = false
}

espModule.Caches = {
    BoxCache = {},
    SkeletonCache = {},
    HealthCache = {},
    TracerCache = {},
    ChamsCache = {}
}

local localPlayer = playersService.LocalPlayer
local currentCamera = workspaceService.CurrentCamera
local updateInterval = 30
local heartbeatConnection = nil
local renderConnection = nil

local function safeCall(callback)
    local success, errorMessage = pcall(callback)
    if not success then
        warn("MatchaEsp Error: " .. tostring(errorMessage))
    end
end

local function lerpNumber(a, b, t)
    return a + (b - a) * t
end

local function getGradientColor(color1, color2, percentage)
    return Color3.new(
        lerpNumber(color1.R, color2.R, percentage),
        lerpNumber(color1.G, color2.G, percentage),
        lerpNumber(color1.B, color2.B, percentage)
    )
end
local function getCameraDistance(worldPosition)
    return (currentCamera.CFrame.Position - worldPosition).Magnitude
end
function espModule.CreateBox(self, _)
    local boxDrawings = {
        Box = Drawing.new("Square"),
        BoxOutline = Drawing.new("Square"),
        BoxTop = Drawing.new("Line"),
        BoxBottom = Drawing.new("Line"),
        BoxLeft = Drawing.new("Line"),
        BoxRight = Drawing.new("Line"),
        Name = Drawing.new("Text"),
        Distance = Drawing.new("Text"),
        HealthText = Drawing.new("Text"),
        HealthBarBackground = Drawing.new("Square"),
        HealthBarOutline = Drawing.new("Square"),
        HealthBar = Drawing.new("Square"),
        CurrentHealth = 100,
        TargetHealth = 100
    }
    
    -- Main box
    boxDrawings.Box.Thickness = 1
    boxDrawings.Box.Color = self.Config.BoxColor
    boxDrawings.Box.Filled = false
    boxDrawings.Box.Visible = false
    
    -- Box outline
    boxDrawings.BoxOutline.Thickness = 3
    boxDrawings.BoxOutline.Color = self.Config.BoxOutlineColor
    boxDrawings.BoxOutline.Filled = false
    boxDrawings.BoxOutline.Visible = false
    boxDrawings.BoxOutline.Transparency = 0.5
    
    -- Gradient lines
    boxDrawings.BoxTop.Thickness = 1
    boxDrawings.BoxTop.Visible = false
    boxDrawings.BoxBottom.Thickness = 1
    boxDrawings.BoxBottom.Visible = false
    boxDrawings.BoxLeft.Thickness = 1
    boxDrawings.BoxLeft.Visible = false
    boxDrawings.BoxRight.Thickness = 1
    boxDrawings.BoxRight.Visible = false
    
    -- Text elements
    boxDrawings.Name.Size = 13
    boxDrawings.Name.Color = Color3.new(1, 1, 1)
    boxDrawings.Name.Outline = true
    boxDrawings.Name.Center = true
    boxDrawings.Name.Visible = false
    boxDrawings.Name.Font = 2
    
    boxDrawings.Distance.Size = 13
    boxDrawings.Distance.Color = Color3.new(1, 1, 1)
    boxDrawings.Distance.Outline = true
    boxDrawings.Distance.Center = true
    boxDrawings.Distance.Visible = false
    boxDrawings.Distance.Font = 2
    
    boxDrawings.HealthText.Size = 12
    boxDrawings.HealthText.Color = Color3.new(1, 1, 1)
    boxDrawings.HealthText.Outline = true
    boxDrawings.HealthText.Center = true
    boxDrawings.HealthText.Visible = false
    boxDrawings.HealthText.Font = 3
    
    -- Health bar background
    boxDrawings.HealthBarBackground.Size = Vector2.new(3, 50)
    boxDrawings.HealthBarBackground.Color = Color3.new(0.1, 0.1, 0.1)
    boxDrawings.HealthBarBackground.Filled = true
    boxDrawings.HealthBarBackground.Transparency = 0.3
    boxDrawings.HealthBarBackground.Visible = false
    
    -- Health bar outline
    boxDrawings.HealthBarOutline.Size = Vector2.new(5, 52)
    boxDrawings.HealthBarOutline.Color = Color3.new(0, 0, 0)
    boxDrawings.HealthBarOutline.Filled = false
    boxDrawings.HealthBarOutline.Thickness = 1
    boxDrawings.HealthBarOutline.Visible = false
    boxDrawings.HealthBarOutline.Transparency = 0.8
    
    -- Health bar
    boxDrawings.HealthBar.Size = Vector2.new(3, 50)
    boxDrawings.HealthBar.Color = Color3.new(0, 1, 0)
    boxDrawings.HealthBar.Filled = true
    boxDrawings.HealthBar.Visible = false
    
    return boxDrawings
end

function espModule.CreateSkeleton(self, targetPlayer)
    local targetCharacter = targetPlayer.Character
    local isR6 = targetCharacter and targetCharacter:FindFirstChild("Torso")
    if isR6 then
        isR6 = not targetCharacter:FindFirstChild("UpperTorso")
    end
    
    local skeletonLines
    if isR6 then
        skeletonLines = {
            HeadToTorso = Drawing.new("Line"),
            TorsoToLeftArm = Drawing.new("Line"),
            TorsoToRightArm = Drawing.new("Line"),
            TorsoToLeftLeg = Drawing.new("Line"),
            TorsoToRightLeg = Drawing.new("Line")
        }
    else
        skeletonLines = {
            HeadToUpperTorso = Drawing.new("Line"),
            UpperTorsoToLowerTorso = Drawing.new("Line"),
            UpperTorsoToLeftUpperArm = Drawing.new("Line"),
            LeftUpperArmToLeftLowerArm = Drawing.new("Line"),
            LeftLowerArmToLeftHand = Drawing.new("Line"),
            UpperTorsoToRightUpperArm = Drawing.new("Line"),
            RightUpperArmToRightLowerArm = Drawing.new("Line"),
            RightLowerArmToRightHand = Drawing.new("Line"),
            LowerTorsoToLeftUpperLeg = Drawing.new("Line"),
            LeftUpperLegToLeftLowerLeg = Drawing.new("Line"),
            LeftLowerLegToLeftFoot = Drawing.new("Line"),
            LowerTorsoToRightUpperLeg = Drawing.new("Line"),
            RightUpperLegToRightLowerLeg = Drawing.new("Line"),
            RightLowerLegToRightFoot = Drawing.new("Line")
        }
    end
    
    for _, line in pairs(skeletonLines) do
        line.Thickness = 1.5
        line.Color = self.Config.SkeletonColor
        line.Visible = false
    end
    
    return skeletonLines
end

function espModule.CreateTracer(self, _)
    local tracerLine = Drawing.new("Line")
    tracerLine.Thickness = 1
    tracerLine.Color = self.Config.TracerColor
    tracerLine.Visible = false
    return tracerLine
end

function espModule.CreateChams(self, targetPlayer)
    local highlight = Instance.new("Highlight")
    highlight.FillColor = self.Config.ChamsColor
    highlight.OutlineColor = self.Config.ChamsOutlineColor
    highlight.FillTransparency = self.Config.ChamsFillTransparency
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = targetPlayer.Character
    highlight.Adornee = targetPlayer.Character
    return highlight
end

function espModule.ClearBox(self, targetPlayer)
    if self.Caches.BoxCache[targetPlayer] then
        self.Caches.BoxCache[targetPlayer].Box:Remove()
        self.Caches.BoxCache[targetPlayer].BoxOutline:Remove()
        self.Caches.BoxCache[targetPlayer].BoxTop:Remove()
        self.Caches.BoxCache[targetPlayer].BoxBottom:Remove()
        self.Caches.BoxCache[targetPlayer].BoxLeft:Remove()
        self.Caches.BoxCache[targetPlayer].BoxRight:Remove()
        self.Caches.BoxCache[targetPlayer].Name:Remove()
        self.Caches.BoxCache[targetPlayer].Distance:Remove()
        self.Caches.BoxCache[targetPlayer].HealthText:Remove()
        self.Caches.BoxCache[targetPlayer].HealthBarBackground:Remove()
        self.Caches.BoxCache[targetPlayer].HealthBarOutline:Remove()
        self.Caches.BoxCache[targetPlayer].HealthBar:Remove()
        self.Caches.BoxCache[targetPlayer] = nil
    end
end

function espModule.ClearSkeleton(self, targetPlayer)
    if self.Caches.SkeletonCache[targetPlayer] then
        for _, line in pairs(self.Caches.SkeletonCache[targetPlayer]) do
            line:Remove()
        end
        self.Caches.SkeletonCache[targetPlayer] = nil
    end
end

function espModule.ClearTracer(self, targetPlayer)
    if self.Caches.TracerCache[targetPlayer] then
        self.Caches.TracerCache[targetPlayer]:Remove()
        self.Caches.TracerCache[targetPlayer] = nil
    end
end

function espModule.ClearChams(self, targetPlayer)
    if self.Caches.ChamsCache[targetPlayer] then
        self.Caches.ChamsCache[targetPlayer]:Destroy()
        self.Caches.ChamsCache[targetPlayer] = nil
    end
end

function espModule.UpdateBox(self)
    if self.State.BoxEnabled or self.State.NameEnabled or self.State.DistanceEnabled or self.State.HealthTextEnabled or self.State.HealthBarEnabled then
        if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            local cameraPos = currentCamera.CFrame.Position
            
            for _, otherPlayer in ipairs(playersService:GetPlayers()) do
                if otherPlayer ~= localPlayer then
                    if otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") and otherPlayer.Character:FindFirstChild("Humanoid") then
                        local otherCharacter = otherPlayer.Character
                        local otherHumanoid = otherCharacter.Humanoid
                        
                        if otherHumanoid.Health > 0 then
                            local otherRoot = otherCharacter.HumanoidRootPart
                            local distance = (cameraPos - otherRoot.Position).Magnitude
                            
                            if self.Config.ESPDistance >= distance then
                                if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                                    self:ClearBox(otherPlayer)
                                else
                                    if not self.Caches.BoxCache[otherPlayer] then
                                        self.Caches.BoxCache[otherPlayer] = self:CreateBox(otherPlayer)
                                    end
                                    
                                    local boxDrawings = self.Caches.BoxCache[otherPlayer]
                                    local rootScreenPos, rootOnScreen = currentCamera:WorldToViewportPoint(otherRoot.Position)
                                    
                                    if rootOnScreen then
                                        local headPart = otherCharacter:FindFirstChild("Head")
                                        local headTopScreenPos = headPart and currentCamera:WorldToViewportPoint(headPart.Position + Vector3.new(0, 1, 0)) or currentCamera:WorldToViewportPoint(otherRoot.Position + Vector3.new(0, 3, 0))
                                        local feetScreenPos = currentCamera:WorldToViewportPoint(otherRoot.Position - Vector3.new(0, 3, 0))
                                        
                                        local height = math.abs(headTopScreenPos.Y - feetScreenPos.Y)
                                        local width = height * 0.66
                                        local centerPos = Vector2.new(rootScreenPos.X, (headTopScreenPos.Y + feetScreenPos.Y) / 2)
                                        
                                        -- Update box
                                        if self.State.BoxEnabled then
                                            if self.Config.BoxGradientEnabled then
                                                -- Gradient box using lines
                                                local topLeft = centerPos - Vector2.new(width / 2, height / 2)
                                                local topRight = centerPos + Vector2.new(width / 2, -height / 2)
                                                local bottomLeft = centerPos + Vector2.new(-width / 2, height / 2)
                                                local bottomRight = centerPos + Vector2.new(width / 2, height / 2)
                                                
                                                boxDrawings.BoxTop.From = topLeft
                                                boxDrawings.BoxTop.To = topRight
                                                boxDrawings.BoxTop.Color = self.Config.BoxGradientColor1
                                                boxDrawings.BoxTop.Visible = true
                                                
                                                boxDrawings.BoxBottom.From = bottomLeft
                                                boxDrawings.BoxBottom.To = bottomRight
                                                boxDrawings.BoxBottom.Color = self.Config.BoxGradientColor2
                                                boxDrawings.BoxBottom.Visible = true
                                                
                                                boxDrawings.BoxLeft.From = topLeft
                                                boxDrawings.BoxLeft.To = bottomLeft
                                                boxDrawings.BoxLeft.Color = self.Config.BoxGradientColor1
                                                boxDrawings.BoxLeft.Visible = true
                                                
                                                boxDrawings.BoxRight.From = topRight
                                                boxDrawings.BoxRight.To = bottomRight
                                                boxDrawings.BoxRight.Color = self.Config.BoxGradientColor2
                                                boxDrawings.BoxRight.Visible = true
                                                
                                                boxDrawings.Box.Visible = false
                                            else
                                                boxDrawings.Box.Size = Vector2.new(width, height)
                                                boxDrawings.Box.Position = centerPos - Vector2.new(width / 2, height / 2)
                                                boxDrawings.Box.Color = self.Config.BoxColor
                                                boxDrawings.Box.Visible = true
                                                
                                                boxDrawings.BoxTop.Visible = false
                                                boxDrawings.BoxBottom.Visible = false
                                                boxDrawings.BoxLeft.Visible = false
                                                boxDrawings.BoxRight.Visible = false
                                            end
                                            
                                            -- Box outline
                                            if self.Config.BoxOutlineEnabled then
                                                boxDrawings.BoxOutline.Size = Vector2.new(width + 2, height + 2)
                                                boxDrawings.BoxOutline.Position = centerPos - Vector2.new((width + 2) / 2, (height + 2) / 2)
                                                boxDrawings.BoxOutline.Color = self.Config.BoxOutlineColor
                                                boxDrawings.BoxOutline.Visible = true
                                            else
                                                boxDrawings.BoxOutline.Visible = false
                                            end
                                        else
                                            boxDrawings.Box.Visible = false
                                            boxDrawings.BoxOutline.Visible = false
                                            boxDrawings.BoxTop.Visible = false
                                            boxDrawings.BoxBottom.Visible = false
                                            boxDrawings.BoxLeft.Visible = false
                                            boxDrawings.BoxRight.Visible = false
                                        end
                                        
                                        -- Update name
                                        boxDrawings.Name.Text = otherPlayer.Name
                                        boxDrawings.Name.Position = Vector2.new(rootScreenPos.X, headTopScreenPos.Y - 18)
                                        boxDrawings.Name.Visible = self.State.NameEnabled
                                        
                                        -- Update distance
                                        boxDrawings.Distance.Text = math.floor(distance) .. "m"
                                        boxDrawings.Distance.Position = Vector2.new(rootScreenPos.X, feetScreenPos.Y + 5)
                                        boxDrawings.Distance.Visible = self.State.DistanceEnabled
                                        
                                        -- Update health bar
                                        if self.State.HealthBarEnabled then
                                            local healthPercent = otherHumanoid.Health / otherHumanoid.MaxHealth
                                            local barWidth = 3
                                            local barX = centerPos.X - width / 2 - 8
                                            local barY = centerPos.Y - height / 2
                                            
                                            -- Lerp health
                                            boxDrawings.TargetHealth = healthPercent * 100
                                            boxDrawings.CurrentHealth = lerpNumber(boxDrawings.CurrentHealth, boxDrawings.TargetHealth, self.Config.HealthBarLerpSpeed)
                                            local lerpedPercent = boxDrawings.CurrentHealth / 100
                                            
                                            -- Background
                                            boxDrawings.HealthBarBackground.Position = Vector2.new(barX, barY)
                                            boxDrawings.HealthBarBackground.Size = Vector2.new(barWidth, height)
                                            boxDrawings.HealthBarBackground.Visible = true
                                            
                                            -- Outline
                                            boxDrawings.HealthBarOutline.Position = Vector2.new(barX - 1, barY - 1)
                                            boxDrawings.HealthBarOutline.Size = Vector2.new(barWidth + 2, height + 2)
                                            boxDrawings.HealthBarOutline.Visible = true
                                            
                                            -- Health bar with gradient color
                                            local healthColor = getGradientColor(Color3.new(1, 0, 0), Color3.new(0, 1, 0), lerpedPercent)
                                            boxDrawings.HealthBar.Position = Vector2.new(barX, barY + height * (1 - lerpedPercent))
                                            boxDrawings.HealthBar.Size = Vector2.new(barWidth, height * lerpedPercent)
                                            boxDrawings.HealthBar.Color = healthColor
                                            boxDrawings.HealthBar.Visible = true
                                            
                                            if self.State.HealthTextEnabled then
                                                boxDrawings.HealthText.Text = tostring(math.floor(boxDrawings.CurrentHealth))
                                            
                                                -- Đặt text ra ngoài, bên trái health bar
                                                local textX = barX - 6
                                                local textY = barY + height * (1 - lerpedPercent)
                                            
                                                -- Clamp để không vượt khỏi bar
                                                if textY < barY then
                                                    textY = barY
                                                elseif textY > barY + height - 10 then
                                                    textY = barY + height - 10
                                                end
                                            
                                                boxDrawings.HealthText.Position = Vector2.new(textX, textY)
                                                boxDrawings.HealthText.Color = healthColor
                                                boxDrawings.HealthText.Center = false
                                                boxDrawings.HealthText.Visible = true
                                            else
                                                boxDrawings.HealthText.Visible = false
                                            end
                                        else
                                            boxDrawings.HealthBarBackground.Visible = false
                                            boxDrawings.HealthBarOutline.Visible = false
                                            boxDrawings.HealthBar.Visible = false
                                            boxDrawings.HealthText.Visible = false
                                        end
                                    else
                                        boxDrawings.Box.Visible = false
                                        boxDrawings.BoxOutline.Visible = false
                                        boxDrawings.BoxTop.Visible = false
                                        boxDrawings.BoxBottom.Visible = false
                                        boxDrawings.BoxLeft.Visible = false
                                        boxDrawings.BoxRight.Visible = false
                                        boxDrawings.Name.Visible = false
                                        boxDrawings.Distance.Visible = false
                                        boxDrawings.HealthText.Visible = false
                                        boxDrawings.HealthBarBackground.Visible = false
                                        boxDrawings.HealthBarOutline.Visible = false
                                        boxDrawings.HealthBar.Visible = false
                                    end
                                end
                            else
                                self:ClearBox(otherPlayer)
                            end
                        else
                            self:ClearBox(otherPlayer)
                        end
                    else
                        self:ClearBox(otherPlayer)
                    end
                end
            end
        else
            for player, _ in pairs(self.Caches.BoxCache) do
                self:ClearBox(player)
            end
        end
    else
        for player, _ in pairs(self.Caches.BoxCache) do
            self:ClearBox(player)
        end
    end
end

function espModule.UpdateSkeleton(self)
    if not self.State.SkeletonEnabled then
        for player, _ in pairs(self.Caches.SkeletonCache) do
            self:ClearSkeleton(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.SkeletonCache) do
            self:ClearSkeleton(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            if otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") and otherPlayer.Character:FindFirstChild("Humanoid") then
                local otherCharacter = otherPlayer.Character
                
                if otherCharacter.Humanoid.Health > 0 then
                    local otherRoot = otherCharacter.HumanoidRootPart
                    
                    if (cameraPos - otherRoot.Position).Magnitude <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearSkeleton(otherPlayer)
                        else
                            if not self.Caches.SkeletonCache[otherPlayer] then
                                self.Caches.SkeletonCache[otherPlayer] = self:CreateSkeleton(otherPlayer)
                            end
                            
                            local skeletonLines = self.Caches.SkeletonCache[otherPlayer]
                            local isR6 = otherCharacter:FindFirstChild("Torso") and not otherCharacter:FindFirstChild("UpperTorso")
                            
                            -- Rest of skeleton update code remains the same...
                            -- (Keeping the original skeleton logic to maintain compatibility)
                        end
                    else
                        self:ClearSkeleton(otherPlayer)
                    end
                else
                    self:ClearSkeleton(otherPlayer)
                end
            else
                self:ClearSkeleton(otherPlayer)
            end
        end
    end
end

function espModule.UpdateTracer(self)
    if not self.State.TracerEnabled then
        for player, _ in pairs(self.Caches.TracerCache) do
            self:ClearTracer(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.TracerCache) do
            self:ClearTracer(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    local viewportSize = currentCamera.ViewportSize
    local originPos
    
    if self.Config.TracerOrigin == "Bottom Screen" then
        originPos = Vector2.new(viewportSize.X / 2, viewportSize.Y)
    elseif self.Config.TracerOrigin == "Cursor" then
        originPos = userInputService:GetMouseLocation()
    elseif self.Config.TracerOrigin == "Top Screen" then
        originPos = Vector2.new(viewportSize.X / 2, 0)
    end
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            if otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") and otherPlayer.Character:FindFirstChild("Humanoid") then
                local otherCharacter = otherPlayer.Character
                
                if otherCharacter.Humanoid.Health > 0 then
                    local tracerTarget = otherCharacter:FindFirstChild("Head") or otherCharacter.HumanoidRootPart
                    
                    if (cameraPos - tracerTarget.Position).Magnitude <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearTracer(otherPlayer)
                        else
                            if not self.Caches.TracerCache[otherPlayer] then
                                self.Caches.TracerCache[otherPlayer] = self:CreateTracer(otherPlayer)
                            end
                            
                            local tracerLine = self.Caches.TracerCache[otherPlayer]
                            local targetScreenPos, targetOnScreen = currentCamera:WorldToViewportPoint(tracerTarget.Position)
                            
                            tracerLine.From = originPos
                            tracerLine.To = Vector2.new(targetScreenPos.X, targetScreenPos.Y)
                            tracerLine.Visible = targetOnScreen
                        end
                    else
                        self:ClearTracer(otherPlayer)
                    end
                else
                    self:ClearTracer(otherPlayer)
                end
            else
                self:ClearTracer(otherPlayer)
            end
        end
    end
end

function espModule.UpdateChams(self)
    if not self.State.ChamsEnabled then
        for player, _ in pairs(self.Caches.ChamsCache) do
            self:ClearChams(player)
        end
        return
    end
    
    if not (localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")) then
        for player, _ in pairs(self.Caches.ChamsCache) do
            self:ClearChams(player)
        end
        return
    end
    
    local cameraPos = currentCamera.CFrame.Position
    
    for _, otherPlayer in ipairs(playersService:GetPlayers()) do
        if otherPlayer ~= localPlayer then
            if otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") and otherPlayer.Character:FindFirstChild("Humanoid") then
                local otherCharacter = otherPlayer.Character
                
                if otherCharacter.Humanoid.Health > 0 then
                    local otherRoot = otherCharacter.HumanoidRootPart
                    
                    if (cameraPos - otherRoot.Position).Magnitude <= self.Config.ESPDistance then
                        if self.Config.TeamCheck and localPlayer.Team and otherPlayer.Team == localPlayer.Team then
                            self:ClearChams(otherPlayer)
                        elseif not self.Caches.ChamsCache[otherPlayer] then
                            self.Caches.ChamsCache[otherPlayer] = self:CreateChams(otherPlayer)
                        end
                    else
                        self:ClearChams(otherPlayer)
                    end
                else
                    self:ClearChams(otherPlayer)
                end
            else
                self:ClearChams(otherPlayer)
            end
        end
    end
end

function espModule.new()
    return setmetatable({}, espModule)
end

function espModule.InitiateBox(self, newColor, enable)
    self.State.BoxEnabled = enable ~= false
    if newColor then
        self.Config.BoxColor = newColor
        for _, drawings in pairs(self.Caches.BoxCache) do
            drawings.Box.Color = newColor
        end
    end
end

function espModule.InitiateName(self, enable)
    self.State.NameEnabled = enable == true
end

function espModule.InitiateDistance(self, enable)
    self.State.DistanceEnabled = enable == true
end

function espModule.InitiateSkeleton(self, newColor, enable)
    self.State.SkeletonEnabled = enable ~= false
    if newColor then
        self.Config.SkeletonColor = newColor
        for _, lines in pairs(self.Caches.SkeletonCache) do
            for _, line in pairs(lines) do
                line.Color = newColor
            end
        end
    end
end

function espModule.InitiateHealthText(self, enable)
    self.State.HealthTextEnabled = enable == true
end

function espModule.InitiateHealthBar(self, enable)
    self.State.HealthBarEnabled = enable == true
end

function espModule.InitiateTracer(self, newColor, newOrigin, enable)
    self.State.TracerEnabled = enable ~= false
    if newColor then
        self.Config.TracerColor = newColor
        for _, line in pairs(self.Caches.TracerCache) do
            line.Color = newColor
        end
    end
    if newOrigin then
        self.Config.TracerOrigin = newOrigin
    end
end

function espModule.InitiateChams(self, newColor, enable)
    self.State.ChamsEnabled = enable ~= false
    if newColor then
        self.Config.ChamsColor = newColor
        for _, highlight in pairs(self.Caches.ChamsCache) do
            highlight.FillColor = newColor
        end
    end
end

function espModule.SetDistance(self, newDistance)
    self.Config.ESPDistance = newDistance
end

function espModule.TeamCheck(self, enable)
    self.Config.TeamCheck = enable
end

function espModule.Cleanup(self)
    for player, _ in pairs(self.Caches.BoxCache) do
        self:ClearBox(player)
    end
    for player, _ in pairs(self.Caches.SkeletonCache) do
        self:ClearSkeleton(player)
    end
    for player, _ in pairs(self.Caches.TracerCache) do
        self:ClearTracer(player)
    end
    for player, _ in pairs(self.Caches.ChamsCache) do
        self:ClearChams(player)
    end
end

function espModule.Destroy(self)
    self:Cleanup()
    if heartbeatConnection then
        heartbeatConnection:Disconnect()
    end
    if renderConnection then
        renderConnection:Disconnect()
    end
    self.State.BoxEnabled = false
    self.State.NameEnabled = false
    self.State.DistanceEnabled = false
    self.State.SkeletonEnabled = false
    self.State.HealthTextEnabled = false
    self.State.HealthBarEnabled = false
    self.State.TracerEnabled = false
    self.State.ChamsEnabled = false
end

function espModule.Initialize(self)
    playersService.PlayerRemoving:Connect(function(removedPlayer)
        safeCall(function()
            self:ClearBox(removedPlayer)
            self:ClearSkeleton(removedPlayer)
            self:ClearTracer(removedPlayer)
            self:ClearChams(removedPlayer)
        end)
    end)
    
    playersService.PlayerAdded:Connect(function(addedPlayer)
        addedPlayer.CharacterAdded:Connect(function(newCharacter)
            newCharacter.AncestryChanged:Connect(function()
                if not newCharacter:IsDescendantOf(workspaceService) then
                    safeCall(function()
                        self:ClearBox(addedPlayer)
                        self:ClearSkeleton(addedPlayer)
                        self:ClearTracer(addedPlayer)
                        self:ClearChams(addedPlayer)
                    end)
                end
            end)
            
            local humanoid = newCharacter:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.Died:Connect(function()
                    safeCall(function()
                        self:ClearBox(addedPlayer)
                        self:ClearSkeleton(addedPlayer)
                        self:ClearTracer(addedPlayer)
                        self:ClearChams(addedPlayer)
                    end)
                end)
            end
        end)
    end)
    
    heartbeatConnection = runService.Heartbeat:Connect(function()
        if os.clock() % updateInterval < 0.1 then
            safeCall(function()
                self:Cleanup()
            end)
        end
    end)
    
    renderConnection = runService.RenderStepped:Connect(function()
        safeCall(function()
            self:UpdateBox()
        end)
        safeCall(function()
            self:UpdateSkeleton()
        end)
        safeCall(function()
            self:UpdateTracer()
        end)
        safeCall(function()
            self:UpdateChams()
        end)
    end)
end

return espModule
